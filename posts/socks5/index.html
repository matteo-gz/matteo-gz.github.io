<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>socks5 协议 - matteo's blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="socks5 协议"><meta property="og:description" content="资料 rfc1928 SOCKS Protocol Version 5
https://datatracker.ietf.org/doc/html/rfc1928
socks5目标: TCP 和 UDP 域中的客户端-服务器应用程序提供一个框架，以便方便、安全地使用网络防火墙的服务
字节序 0x01234567 在字节顺序中表现
Big-Endian
0x100: 0x01 0x101: 0x23 0x102: 0x45 0x103: 0x67 Little-Endian
0x100: 0x67 0x101: 0x45 0x102: 0x23 0x103: 0x01 rfc1929 Username/Password Authentication for SOCKS V5
https://datatracker.ietf.org/doc/html/rfc1929
过程 1.TCP连接 3次握手后,客户端 连接 服务端socks5端口1080
2.协商环节 2.1.客户端发送给服务端 X'05&rsquo; , X开头的数据都是十六进制
报文格式:
+----+----------+----------+ |VER | NMETHODS | METHODS | +----+----------+----------+ | 1 | 1 | 1 to 255 | +----+----------+----------+ 字段解释:"><meta property="og:type" content="article"><meta property="og:url" content="https://matteo-gz.github.io/posts/socks5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-13T21:16:44+08:00"><meta property="article:modified_time" content="2023-12-13T21:16:44+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="socks5 协议"><meta name=twitter:description content="资料 rfc1928 SOCKS Protocol Version 5
https://datatracker.ietf.org/doc/html/rfc1928
socks5目标: TCP 和 UDP 域中的客户端-服务器应用程序提供一个框架，以便方便、安全地使用网络防火墙的服务
字节序 0x01234567 在字节顺序中表现
Big-Endian
0x100: 0x01 0x101: 0x23 0x102: 0x45 0x103: 0x67 Little-Endian
0x100: 0x67 0x101: 0x45 0x102: 0x23 0x103: 0x01 rfc1929 Username/Password Authentication for SOCKS V5
https://datatracker.ietf.org/doc/html/rfc1929
过程 1.TCP连接 3次握手后,客户端 连接 服务端socks5端口1080
2.协商环节 2.1.客户端发送给服务端 X'05&rsquo; , X开头的数据都是十六进制
报文格式:
+----+----------+----------+ |VER | NMETHODS | METHODS | +----+----------+----------+ | 1 | 1 | 1 to 255 | +----+----------+----------+ 字段解释:"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://matteo-gz.github.io/posts/socks5/><link rel=prev href=https://matteo-gz.github.io/posts/gpu/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"socks5 协议","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/matteo-gz.github.io\/posts\/socks5\/"},"genre":"posts","wordcount":740,"url":"https:\/\/matteo-gz.github.io\/posts\/socks5\/","datePublished":"2023-12-13T21:16:44+08:00","dateModified":"2023-12-13T21:16:44+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Author"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="matteo's blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/Logo_Matteo-100-360x135px.png data-srcset="/images/Logo_Matteo-100-360x135px.png, /images/Logo_Matteo-100-360x135px.png 1.5x, /images/Logo_Matteo-100-360x135px.png 2x" data-sizes=auto alt=/images/Logo_Matteo-100-360x135px.png title=/images/Logo_Matteo-100-360x135px.png>'s blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/links/>Bookmarks </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="matteo's blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/Logo_Matteo-100-360x135px.png data-srcset="/images/Logo_Matteo-100-360x135px.png, /images/Logo_Matteo-100-360x135px.png 1.5x, /images/Logo_Matteo-100-360x135px.png 2x" data-sizes=auto alt=/images/Logo_Matteo-100-360x135px.png title=/images/Logo_Matteo-100-360x135px.png>'s blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/links/ title>Bookmarks</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">socks5 协议</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Author</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-12-13>2023-12-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;740 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#资料>资料</a><ul><li><a href=#rfc1928>rfc1928</a></li><li><a href=#字节序>字节序</a></li><li><a href=#rfc1929>rfc1929</a></li></ul></li><li><a href=#过程>过程</a><ul><li><a href=#1tcp连接>1.TCP连接</a></li><li><a href=#2协商环节>2.协商环节</a></li><li><a href=#21客户端发送给服务端>2.1.客户端发送给服务端</a></li><li><a href=#22服务端响应客户端>2.2.服务端响应客户端</a></li><li><a href=#3子协商>3.子协商</a></li><li><a href=#31用户名密码认证>3.1.用户名密码认证</a></li><li><a href=#311客户端发送>3.1.1.客户端发送</a></li><li><a href=#312服务端响应>3.1.2.服务端响应</a></li><li><a href=#4requests请求>4.Requests请求</a></li><li><a href=#5replies>5.Replies</a></li></ul></li><li><a href=#类型>类型</a><ul><li><a href=#connect>CONNECT</a></li><li><a href=#bind>BIND</a></li><li><a href=#udp-associate>UDP ASSOCIATE</a></li></ul></li><li><a href=#基于-udp-的客户端程序>基于 UDP 的客户端程序</a><ul><li><a href=#数据包转发>数据包转发</a></li><li><a href=#回复数据包处理>回复数据包处理</a></li><li><a href=#数据包分片>数据包分片</a></li><li><a href=#不支持分片的实现>不支持分片的实现</a></li><li><a href=#udp-编程接口>UDP 编程接口</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=资料>资料</h2><h3 id=rfc1928>rfc1928</h3><p>SOCKS Protocol Version 5</p><p><a href=https://datatracker.ietf.org/doc/html/rfc1928 target=_blank rel="noopener noreffer">https://datatracker.ietf.org/doc/html/rfc1928</a></p><blockquote><p>socks5目标: TCP 和 UDP 域中的客户端-服务器应用程序提供一个框架，以便方便、安全地使用网络防火墙的服务</p></blockquote><h3 id=字节序>字节序</h3><blockquote><p>0x01234567 在字节顺序中表现</p></blockquote><p>Big-Endian</p><pre tabindex=0><code>0x100: 0x01
0x101: 0x23
0x102: 0x45
0x103: 0x67
</code></pre><p>Little-Endian</p><pre tabindex=0><code>0x100: 0x67
0x101: 0x45
0x102: 0x23
0x103: 0x01
</code></pre><h3 id=rfc1929>rfc1929</h3><p>Username/Password Authentication for SOCKS V5</p><p><a href=https://datatracker.ietf.org/doc/html/rfc1929 target=_blank rel="noopener noreffer">https://datatracker.ietf.org/doc/html/rfc1929</a></p><h2 id=过程>过程</h2><h3 id=1tcp连接>1.TCP连接</h3><p>3次握手后,<code>客户端</code> 连接 <code>服务端</code>socks5端口1080</p><h3 id=2协商环节>2.协商环节</h3><h3 id=21客户端发送给服务端>2.1.客户端发送给服务端</h3><blockquote><p>X'05&rsquo; , X开头的数据都是十六进制</p></blockquote><p>报文格式:</p><pre tabindex=0><code>+----+----------+----------+
|VER | NMETHODS | METHODS  |
+----+----------+----------+
| 1  |    1     | 1 to 255 |
+----+----------+----------+
</code></pre><p>字段解释:</p><ul><li><code>VER</code> 版本号,<code>X'05'</code></li><li><code>NMETHODS</code> 支持的认证方法数量</li><li><code>METHODS</code> 支持的认证方法ID列表</li></ul><p>最小3个byte长度:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>socks5</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>VER</span>      <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>NMETHODS</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>METHODS</span>  <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>最大257byte长度:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>socks5</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>VER</span>      <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>NMETHODS</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>METHODS</span>  <span class=p>[</span><span class=mi>255</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=22服务端响应客户端>2.2.服务端响应客户端</h3><pre tabindex=0><code>+----+--------+
|VER | METHOD |
+----+--------+
| 1  |   1    |
+----+--------+
</code></pre><p>报文格式:</p><ul><li><code>VER</code> 版本号</li><li><code>METHOD</code> 从<code>客户端</code>给定选择的认证方法里面选择其中一种.</li></ul><p>METHOD值:</p><ul><li><code>X'00'</code> 无认证需要</li><li><code>X'01'</code> GSSAPI</li><li><code>X'02'</code> 用户名,密码方式验证</li><li><code>X'03'</code> to <code>X'7F'</code> IANA 分配</li><li><code>X'80'</code> to <code>X'FE'</code> 私人方法保留</li><li><code>X'FF'</code> 没有可接受的方法列表,此时认证失败,<code>客户端</code>必须关闭连接.</li></ul><p>总共2个byte长度:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>socks5</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>VER</span>     <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=nx>METHOD</span>  <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h3 id=3子协商>3.子协商</h3><p>若<code>服务端</code>响应METHOD为<code>X'02'</code>,则进行用户名密码校验</p><h3 id=31用户名密码认证>3.1.用户名密码认证</h3><h3 id=311客户端发送>3.1.1.客户端发送</h3><pre tabindex=0><code>+----+------+----------+------+----------+
|VER | ULEN |  UNAME   | PLEN |  PASSWD  |
+----+------+----------+------+----------+
| 1  |  1   | 1 to 255 |  1   | 1 to 255 |
+----+------+----------+------+----------+
</code></pre><ul><li>VER socks5版本</li><li>ULEN 用户名长度</li><li>UNAME 用户名</li><li>PLEN 密码长度</li><li>PASSWD 密码</li></ul><p>最小长度5个字节</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>  <span class=nx>Ver</span>    <span class=kt>byte</span>
</span></span><span class=line><span class=cl>  <span class=nx>Ulen</span>   <span class=kt>byte</span>
</span></span><span class=line><span class=cl>  <span class=nx>Uname</span>  <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span> 
</span></span><span class=line><span class=cl>  <span class=nx>Plen</span>   <span class=kt>byte</span> 
</span></span><span class=line><span class=cl>  <span class=nx>Passwd</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span></code></pre></div><p>最大长度513字节</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>  <span class=nx>Ver</span>    <span class=kt>byte</span>
</span></span><span class=line><span class=cl>  <span class=nx>Ulen</span>   <span class=kt>byte</span>
</span></span><span class=line><span class=cl>  <span class=nx>Uname</span>  <span class=p>[</span><span class=mi>255</span><span class=p>]</span><span class=kt>byte</span> 
</span></span><span class=line><span class=cl>  <span class=nx>Plen</span>   <span class=kt>byte</span> 
</span></span><span class=line><span class=cl>  <span class=nx>Passwd</span> <span class=p>[</span><span class=mi>255</span><span class=p>]</span><span class=kt>byte</span>
</span></span></code></pre></div><h3 id=312服务端响应>3.1.2.服务端响应</h3><pre tabindex=0><code>+----+--------+
|VER | STATUS |
+----+--------+
| 1  |   1    |
+----+--------+
</code></pre><ul><li>STATUS<ul><li>X'00&rsquo; 表示成功</li><li>其他值则客户端必须关闭连接</li></ul></li></ul><p>长度为2byte</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>VER</span>    <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=nx>STATUS</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kt>byte</span>
</span></span></code></pre></div><h3 id=4requests请求>4.Requests请求</h3><pre tabindex=0><code>+----+-----+-------+------+----------+----------+
|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+
</code></pre><ul><li>VER: 协议版本</li><li>CMD: 命令<ul><li><code>0x01</code>: CONNECT 建立 TCP 连接</li><li><code>0x02</code>: BIND 上报反向连接地址</li><li><code>0x03</code>: 关联 UDP 请求</li></ul></li><li>RSV: 保留字段,值为 <code>0x00</code></li><li>ATYP: 地址类型<ul><li><code>0x01</code>: IPv4</li><li><code>0x03</code>: 域名 fully-qualified domain name.</li><li><code>0x04</code>:IPv6</li></ul></li><li>DST.ADDR 期望目标地址</li><li>DST.PORT 期望目标端口 采用big-endian表示</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>AddressType</span> <span class=kt>byte</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=nx>IPV4</span> <span class=nx>AddressType</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>IPV6</span> <span class=nx>AddressType</span> <span class=p>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=nx>DOMAIN</span> <span class=nx>AddressType</span> <span class=p>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>IPv4len</span> <span class=p>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=nx>IPv6len</span> <span class=p>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SocksReply</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>Ver</span>    <span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=nx>Cmd</span>    <span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=nx>Rsv</span>    <span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=nx>Atyp</span>   <span class=nx>AddressType</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>DstAddr</span> <span class=p>[</span><span class=nx>addressLength</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=nx>DstPort</span> <span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>addressLength</span><span class=p>(</span><span class=nx>atyp</span> <span class=nx>AddressType</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>atyp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>IPV4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>net</span><span class=p>.</span><span class=nx>IPv4len</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>IPV6</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>net</span><span class=p>.</span><span class=nx>IPv6len</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>DOMAIN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>toDstAddr</span><span class=p>(</span><span class=nx>domain</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 255为域名最大长度
</span></span></span><span class=line><span class=cl><span class=c1>// 最大域名长度 https://en.wikipedia.org/wiki/Fully_qualified_domain_name
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// https://en.wikipedia.org/wiki/SOCKS 
</span></span></span><span class=line><span class=cl><span class=c1>//1 byte of name length followed by 1–255 bytes for the domain name
</span></span></span><span class=line><span class=cl><span class=c1>// 比如域名长度为 200 ,则第一位值为200,后面是域名值
</span></span></span><span class=line><span class=cl><span class=c1>//  The first octet of the address field contains the number of octets of name that follow, there is no terminating NUL octet.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>toDstAddr</span><span class=p>(</span><span class=nx>domain</span> <span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    	
</span></span><span class=line><span class=cl>  <span class=c1>// 将域名转换为 []byte 类型
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>domainBytes</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>domain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 计算域名的字节长度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>domainLen</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>domainBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 创建一个包含域名字节长度和域名字节的 []byte 类型的数组
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dstAddr</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1</span><span class=o>+</span><span class=nx>domainLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 将域名的字节长度写入 dstAddr 的第一个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dstAddr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>=</span> <span class=nb>byte</span><span class=p>(</span><span class=nx>domainLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 将域名的字节写入 dstAddr 的剩余字节
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nb>copy</span><span class=p>(</span><span class=nx>dstAddr</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span> <span class=nx>domainBytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>dstAddr</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>域名下最大长度为262字节,7(固定字段长度)+域名长度</p><p>ipv4最大长度为10字节</p><p>ipv4最大长度为22字节</p><h3 id=5replies>5.Replies</h3><pre tabindex=0><code>+----+-----+-------+------+----------+----------+
|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+
</code></pre><ul><li>VER 协议版本</li><li>REP 回复字段<ul><li><code>X'00'</code> 已成功</li><li><code>X'01'</code> 通常的socks服务失败</li><li><code>X'02'</code> 规则集内不允许</li><li><code>X'03'</code> 网络不可达</li><li><code>X'04'</code> 主机不可达</li><li><code>X'05'</code> 连接已拒绝</li><li><code>X'06'</code> TTL 过期</li><li><code>X'07'</code> 命令不被支持</li><li><code>X'08'</code> 地址类型不被支持</li><li><code>X'09'</code> 至 <code>X'FF'</code> 没有定义</li></ul></li><li>RSV</li><li>ATYP</li><li>BND.ADDR 服务绑定地址</li><li>BND.PORT 服务绑定端口 采用big-endian表示</li></ul><h2 id=类型>类型</h2><h3 id=connect>CONNECT</h3><p>在对<code>CONNECT</code>请求的回复中,<code>BND.PORT</code>包含了服务器分配给连接<code>目标主机</code>的端口号,而<code>BND.ADDR</code>包含了对应的IP地址。</p><p>提供的<code>BND.ADDR</code>地址通常与客户端用来连接SOCKS服务器的IP地址不同,因为这样的服务器通常支持多个网络接口。</p><p>SOCKS服务器应该考虑<code>DST.ADDR</code>和<code>DST.PORT</code>以及客户端源地址和端口来评估<code>CONNECT</code>请求。</p><h3 id=bind>BIND</h3><p><code>BIND</code>请求用于那些需要<code>client</code>接受<code>server</code>连接的协议。</p><p><code>FTP</code>就是一个典型示例,它使用 <code>主</code> <code>client-to-server</code> 连接传输命令和状态报告,
但可能使用<code>server-to-client</code>连接按需传输数据(如LS、GET、PUT)。</p><p>在应用协议中,客户端应该只在使用 <code>CONNECT</code> 请求建立<code>主连接</code>后,才使用 <code>BIND</code> 请求建立<code>次连接</code>.</p><p>SOCKS服务器应该在评估<code>BIND</code>请求时考虑 <code>DST.ADDR</code>和<code>DST.PORT</code>。</p><p>在<code>BIND</code>操作过程中,SOCKS服务器会向客户端发送两个回复。</p><p>第一个回复是在服务器创建并绑定新套接字后发送。</p><p><code>BND.PORT</code>字段包含SOCKS服务器为监听传入连接分配的端口号。</p><p><code>BND.ADDR</code>字段包含相关联的IP地址。</p><p>客户端通常会使用这些信息通过主或控制连接通知应用服务器会合地址。</p><p>第二个回复仅在待定传入连接成功或失败后发送。</p><p>在第二个回复中，<code>BND.PORT</code>和<code>BND.ADDR</code>字段包含连接主机的地址和端口号.</p><h3 id=udp-associate>UDP ASSOCIATE</h3><p><code>UDP ASSOCIATE</code> 请求用于在 <code>UDP 中继进程</code> 中建立一个关联，以便处理 UDP 数据报。</p><p><code>DST.ADDR</code> 和 <code>DST.PORT</code> 字段包含客户端期望用于发送 UDP 数据报的地址和端口。</p><p>服务器可以根据这些信息限制对关联的访问。</p><p>如果客户端在发送 <code>UDP ASSOCIATE</code> 请求时没有这些信息，则必须使用端口号和地址全部为 0。</p><p>UDP 关联会在发起 <code>UDP ASSOCIATE</code> 请求的 TCP 连接终止时 终止。</p><p>在对 <code>UDP ASSOCIATE</code> 请求的响应中，
<code>BND.PORT</code> 和 <code>BND.ADDR</code> 字段指示客户端必须将 UDP 请求消息发送到哪个端口/地址进行中继。</p><h2 id=基于-udp-的客户端程序>基于 UDP 的客户端程序</h2><p>基于 UDP 的客户端必须将数据包发送到 UDP 中继服务器，
端口号为 <code>UDP ASSOCIATE</code> 请求响应中 <code>BND.PORT</code> 字段指定的端口。
如果选定的认证方法支持封装来保证真实性、完整性和/或保密性，数据包必须使用相应的封装方法进行封装。
每个 UDP 数据包都携带一个 UDP 请求头,其中包含</p><pre tabindex=0><code>+----+------+------+----------+----------+----------+
|RSV | FRAG | ATYP | DST.ADDR | DST.PORT |   DATA   |
+----+------+------+----------+----------+----------+
| 2  |  1   |  1   | Variable |    2     | Variable |
+----+------+------+----------+----------+----------+
</code></pre><ul><li>RSV (Reserved)：保留字段，必须设置为 0x0000。</li><li>FRAG (Fragment)：片段标志，用于指示数据包是否被分片：Current fragment number<ul><li>最高位：<ul><li>0：表示数据包没有被分片。</li><li>1：表示数据包是分片的一部分。</li></ul></li><li>其他位：<ul><li>用于表示分片的顺序 范围为1-127</li></ul></li></ul></li><li>ATYP (Address Type)：地址类型，指定目标地址的类型：<ul><li>0x01：IPv4 地址。</li><li>0x03：域名。</li><li>0x04：IPv6 地址。</li></ul></li><li>DST.ADDR (Destination Address)：根据 ATYP 指定的类型，可以是 IP 地址或域名。</li><li>DST.PORT (Destination Port)：目标端口号。</li><li>DATA (User Data)：用户数据，封装后的实际数据内容。</li></ul><h3 id=数据包转发>数据包转发</h3><ul><li>当 UDP 中继服务器决定转发一个 UDP 数据包时，它会默默地进行，不会通知请求客户端。</li><li>同样，它也会丢弃无法或不会转发的数据包。</li></ul><h3 id=回复数据包处理>回复数据包处理</h3><ul><li>当 UDP 中继服务器从远程主机收到回复数据包时，它必须使用上述 UDP 请求头和任何与认证方法相关的封装对该数据包进行封装。</li><li>UDP 中继服务器必须从 SOCKS 服务器获取预计将发送数据包到 <code>BND.PORT</code> 的客户端的 IP 地址。</li><li>它必须丢弃来自任何除了记录在特定关联中的源 IP 地址之外的任何数据包。</li></ul><h3 id=数据包分片>数据包分片</h3><p>FRAG 字段指示数据包是否被分片：</p><ul><li>最高位指示片段序列的结束。</li><li><code>X'00'</code> 值表示该数据包是独立的。</li><li>1 到 127 之间的值指示片段在片段序列中的位置。</li><li></li></ul><p>每个接收器都会有一个用于重新组装片段的队列和一个与这些片段相关的重新组装计时器。</p><ul><li>当重新组装计时器过期或新到达的 <code>FRAG</code> 字段的值小于该片段序列中处理的最高 <code>FRAG</code> 值时，重新组装队列必须重新初始化并放弃相关的片段。</li><li>重新组装计时器必须至少为 5 秒。</li><li>建议应用程序尽可能避免数据包分片。</li></ul><h3 id=不支持分片的实现>不支持分片的实现</h3><p>实现分片是可选的；不支持分片的实现必须丢弃任何 <code>FRAG</code> 字段不是 <code>X'00'</code> 的数据包。</p><h3 id=udp-编程接口>UDP 编程接口</h3><p>一个支持 SOCKS 的 UDP 编程接口必须报告低于操作系统提供的实际空间的可用 UDP 数据包缓冲区大小：</p><ul><li>如果 <code>ATYP</code> 为 <code>X'01'</code>，则减少 10 + 与方法相关的字节。</li><li>如果 <code>ATYP</code> 为 <code>X'03'</code>，则减少 262 + 与方法相关的字节。</li><li>如果 <code>ATYP</code> 为 <code>X'04'</code>，则减少 20 + 与方法相关的字节。</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-12-13</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://matteo-gz.github.io/posts/socks5/ data-title="socks5 协议"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://matteo-gz.github.io/posts/socks5/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://matteo-gz.github.io/posts/socks5/ data-title="socks5 协议"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://matteo-gz.github.io/posts/socks5/ data-title="socks5 协议"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://matteo-gz.github.io/posts/socks5/ data-title="socks5 协议"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/gpu/ class=prev rel=prev title=显卡相关><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>显卡相关</a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.117.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://https-matteo-gz-github-io.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>